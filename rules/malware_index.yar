/*
    RafSec YARA Rules Index
    ========================
    Professional malware detection signatures.
    
    HOW TO ADD RULES:
    1. Create new .yar files in this rules/ folder
    2. Follow YARA syntax
    3. Engine will auto-load all .yar files
*/

// ============================================================
// EICAR Test Signature
// Standard antivirus test file
// ============================================================
rule EICAR_Test_File
{
    meta:
        description = "EICAR Antivirus Test File"
        author = "RafSec Team"
        severity = "test"
        reference = "https://www.eicar.org/"
    
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    
    condition:
        $eicar
}

// ============================================================
// Suspicious Command Execution
// Detects potential command shell invocations
// ============================================================
rule Suspicious_CMD_Execution
{
    meta:
        description = "Suspicious Command Shell Execution"
        author = "RafSec Team"
        severity = "medium"
    
    strings:
        $cmd1 = "cmd.exe" nocase
        $cmd2 = "powershell" nocase
        $cmd3 = "wscript" nocase
        $cmd4 = "cscript" nocase
    
    condition:
        2 of them
}

// ============================================================
// Ransomware Indicators
// Common ransomware behavior patterns
// ============================================================
rule Ransomware_Indicators
{
    meta:
        description = "Potential Ransomware Behavior"
        author = "RafSec Team"
        severity = "critical"
    
    strings:
        $ransom1 = "Your files have been encrypted" nocase
        $ransom2 = "pay bitcoin" nocase
        $ransom3 = "decrypt your files" nocase
        $ransom4 = ".onion" nocase
        $ransom5 = "wallet address" nocase
        $crypto1 = "CryptEncrypt"
        $crypto2 = "CryptDecrypt"
    
    condition:
        2 of ($ransom*) or (1 of ($ransom*) and 1 of ($crypto*))
}

// ============================================================
// Keylogger Indicators
// Keyboard hooking and logging patterns
// ============================================================
rule Keylogger_Indicators
{
    meta:
        description = "Potential Keylogger Behavior"
        author = "RafSec Team"
        severity = "high"
    
    strings:
        $api1 = "GetAsyncKeyState"
        $api2 = "GetKeyState"
        $api3 = "GetKeyboardState"
        $api4 = "SetWindowsHookEx"
        $api5 = "RegisterHotKey"
        $api6 = "keylog" nocase
    
    condition:
        3 of them
}

// ============================================================
// Process Injection
// Memory manipulation for code injection
// ============================================================
rule Process_Injection_Technique
{
    meta:
        description = "Process Injection Technique Detected"
        author = "RafSec Team"
        severity = "critical"
    
    strings:
        $api1 = "VirtualAllocEx"
        $api2 = "WriteProcessMemory"
        $api3 = "CreateRemoteThread"
        $api4 = "NtUnmapViewOfSection"
        $api5 = "QueueUserAPC"
    
    condition:
        3 of them
}

// ============================================================
// Trojan Dropper
// File dropping and execution patterns
// ============================================================
rule Trojan_Dropper
{
    meta:
        description = "Potential Trojan Dropper"
        author = "RafSec Team"
        severity = "high"
    
    strings:
        $drop1 = "URLDownloadToFile"
        $drop2 = "WinHttpOpen"
        $drop3 = "InternetOpen"
        $exec1 = "ShellExecute"
        $exec2 = "CreateProcess"
        $exec3 = "WinExec"
        $temp = "%TEMP%" nocase
        $appdata = "%APPDATA%" nocase
    
    condition:
        (1 of ($drop*)) and (1 of ($exec*)) and (1 of ($temp, $appdata))
}

// ============================================================
// Persistence Mechanisms
// Registry and startup modifications
// ============================================================
rule Persistence_Mechanism
{
    meta:
        description = "Persistence Mechanism Detected"
        author = "RafSec Team"
        severity = "medium"
    
    strings:
        $reg1 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg2 = "Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase
        $api1 = "RegSetValueEx"
        $api2 = "RegCreateKey"
        $schtask = "schtasks" nocase
        $startup = "Startup" nocase
    
    condition:
        2 of them
}

// ============================================================
// Anti-Analysis Techniques
// Debugger/VM detection evasion
// ============================================================
rule Anti_Analysis_Evasion
{
    meta:
        description = "Anti-Analysis Techniques Detected"
        author = "RafSec Team"
        severity = "high"
    
    strings:
        $debug1 = "IsDebuggerPresent"
        $debug2 = "CheckRemoteDebuggerPresent"
        $debug3 = "NtQueryInformationProcess"
        $vm1 = "VMware" nocase
        $vm2 = "VirtualBox" nocase
        $vm3 = "VBOX" nocase
        $sand1 = "SbieDll" nocase  // Sandboxie
        $sand2 = "snxhk" nocase    // Avast sandbox
    
    condition:
        2 of ($debug*) or 2 of ($vm*) or 1 of ($sand*)
}
